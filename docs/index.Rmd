---
title: "SIF 0.05Â°, Brazil"
author: "L. M. Costa & A. R. Panosso"
date: "06/04/2021"
output: html_document
---

## Required libraries for you instal:
ncdf4;
raster;
tidyverse;
geobr; 
sp

# Setting the pathway

the data showed in this code is only a part of the complete database, which can be found at: <https://cornell.app.box.com/s/gkp4moy4grvqsus1q5oz7u5lc30i7o41/folder/100438579357>

```{r}
`%>%` <- magrittr::`%>%` 

arch <- dir("../data-raw/", pattern = ".nc")
n_links <- length(arch)
n_split <- length(stringr::str_split(arch[1],"/",simplify = TRUE))
name.arch <- stringr::str_split_fixed(arch,"/",n=Inf)[,n_split]
dir.arch <- paste0("../data-raw/",name.arch)

```

Creating the data frame and filtering for Brazil

where: x= lon
y=lat

```{r}
for(i in 1:n_links){
  if(i==1){
      sif.005<-raster::brick(dir.arch[i])
  sif.005<- raster::as.data.frame(sif.005[[1]], xy=T)
  sif.005<- na.omit(sif.005)
  sif.005 <- sif.005 %>% 
    dplyr::filter(
      x < -30,
      y < 10
    )
  } else {
     sif.005a<-raster::brick(dir.arch[i])
     sif.005a<- raster::as.data.frame(sif.005a[[1]], xy=T)
     sif.005a<- na.omit(sif.005a)
     sif.005a <- sif.005a %>% 
       dplyr::filter(
         x < -30,
         y < 10
         )
     sif.005 <- rbind(sif.005,sif.005a)
  }
}

```


Checking if the data exists for your region
```{r}
sif.005 %>% 
  ggplot2::ggplot(ggplot2::aes(x,y))+
  ggplot2::geom_point()
```


Creating the polygon for Brazil and making some necessary adjustments for the country

```{r}

br <- geobr::read_country(showProgress = FALSE)
region <- geobr::read_region(showProgress = FALSE)

pol.br <- as.matrix(br$geom[[1]])
pol.br <- pol.br[pol.br[,1]<=-34,] # Adjustment 
pol.br <- pol.br[!((pol.br[,1]>=-38.8 & pol.br[,1]<=-38.6) &
                        (pol.br[,2]>= -19 & pol.br[,2]<= -16)),]

pol_NE <- as.matrix(region$geom[[2]]) # pol North Easth
pol_NE <- pol_NE[pol_NE[,1]<=-34,]# Adjustment
pol_NE <- pol_NE[!((pol_NE[,1]>=-38.7 & pol_NE[,1]<=-38.6) &
                                 pol_NE[,2]<= -15),]
```

Creating a *Logical* variable for extract only the points in Brazil

```{r}

sif.005 <- sif.005 %>% 
  dplyr::mutate(
    point_in_pol = as.logical(sp::point.in.polygon(point.x = x, 
                                               point.y = y,
                                               pol.x = pol.br[,1],
                                               pol.y = pol.br[,2])
                              |
                                sp::point.in.polygon(point.x = x, 
                                                 point.y = y,
                                                 pol.x = pol_NE[,1],
                                                 pol.y = pol_NE[,2])  
                                )
  )

# Checking if works 
ggplot2::ggplot(br) + 
  ggplot2::theme_minimal() +
  ggplot2::geom_point(data=sif.005 %>% dplyr::filter(point_in_pol),
             ggplot2::aes(x=x,y=y))
```

Filtering the data

```{r}

sif.005 <- sif.005 %>%
  dplyr::filter(point_in_pol != FALSE)
```

Checking for outliers and cleaning them from the database
obs: if you need, use this step more than one time


Save the final data frame on a *CSV* file 
```{r}
#write.csv(sif.005, file="C:/Users/SIF.csv")
```


